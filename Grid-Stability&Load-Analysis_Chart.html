<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#0f172a">
    <title>WaliTech | Chart Analytics</title>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highstock/6.0.3/highstock.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highstock/6.0.3/modules/exporting.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        /* --- THEME ENGINE --- */
        :root {
            --bg-body: #020617;
            --bg-card: #0f172a;
            --bg-header: rgba(15, 23, 42, 0.95);
            --border: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #64748b;
            --accent: #3b82f6;
            --success: #22c55e;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: pan-y;
        }

        /* --- HEADER --- */
        #header {
            height: 60px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-header);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            z-index: 50;
            flex-shrink: 0;
            transition: transform 0.3s;
        }

        .brand-btn {
            text-decoration: none;
            color: white;
            font-weight: 800;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.05);
            padding: 8px 16px;
            border-radius: 8px;
            transition: 0.2s;
            min-height: 44px;
        }
        .brand-btn:active { transform: scale(0.95); }

        select#sheetSelector {
            background: var(--bg-card);
            color: white;
            border: 1px solid var(--border);
            padding: 8px 32px 8px 12px;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            outline: none;
            cursor: pointer;
            min-width: 140px;
            max-width: 200px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }

        /* --- MAIN GRID --- */
        #dashboard-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            align-content: start;
            -webkit-overflow-scrolling: touch;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 15px;
            min-height: 350px;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Fullscreen Focus Mode */
        .chart-card.fullscreen {
            position: fixed;
            inset: 0;
            z-index: 100;
            border-radius: 0;
            margin: 0;
            height: 100dvh !important;
            padding: 20px;
            border: none;
        }
        .chart-card.fullscreen .chart-header { margin-top: 10px; }
        .chart-card.fullscreen .chart-body { height: 100%; }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .chart-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .card-actions { display: flex; gap: 15px; align-items: center; }
        .expand-btn { 
            cursor: pointer; 
            color: var(--text-muted); 
            transition: color 0.2s; 
            padding: 8px;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }
        .expand-btn:hover { 
            background: rgba(255,255,255,0.05); 
            color: var(--accent); 
        }

        .chart-body { 
            flex: 1; 
            min-height: 250px; 
            width: 100%; 
            position: relative;
        }
        .full-span { grid-column: 1 / -1; }

        /* --- CONTROLS BAR (Desktop) --- */
        #controls-bar {
            height: 60px;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 50;
            flex-shrink: 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .zoom-group { 
            display: flex; 
            gap: 5px; 
            overflow-x: auto; 
            padding: 5px 0;
            scrollbar-width: none; 
            -webkit-overflow-scrolling: touch;
        }
        .zoom-group::-webkit-scrollbar { display: none; }

        .zoom-btn {
            background: transparent; 
            border: 1px solid var(--border); 
            color: var(--text-muted);
            padding: 8px 14px; 
            border-radius: 6px; 
            font-size: 0.8rem; 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.2s; 
            white-space: nowrap; 
            flex-shrink: 0;
            min-width: 44px;
            min-height: 44px;
        }
        .zoom-btn:hover { background: rgba(255,255,255,0.05); }
        .zoom-btn.active { 
            background: var(--accent); 
            color: white; 
            border-color: var(--accent); 
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .switch-wrapper { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-size: 0.85rem; 
            font-weight: 600; 
            color: var(--text-muted); 
            white-space: nowrap; 
        }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* --- MOBILE FAB & POPUP --- */
        #mobile-fab { 
            display: none; 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            width: 56px; 
            height: 56px; 
            background: var(--accent); 
            color: white; 
            border-radius: 50%; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.5); 
            z-index: 60; 
            border: none; 
            font-size: 1.4rem; 
            cursor: pointer; 
            transition: all 0.2s;
        }
        #mobile-fab:hover { transform: scale(1.05); }
        
        .overlay { 
            position: fixed; 
            inset: 0; 
            background: rgba(2, 6, 23, 0.9); 
            backdrop-filter: blur(4px); 
            z-index: 200; 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
        }
        .spinner { 
            width: 44px; 
            height: 44px; 
            border: 3px solid #1e293b; 
            border-top: 3px solid var(--accent); 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        #no-data-msg { 
            display:none; 
            flex-direction:column; 
            align-items:center; 
            color: var(--text-muted); 
            margin-top: 50px; 
            grid-column: 1/-1; 
            padding: 40px 20px;
            text-align: center;
        }

        /* Status Messages */
        .status-msg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            display: none;
            pointer-events: none;
            width: 90%;
            max-width: 300px;
        }

        @media (max-width: 768px) {
            #dashboard-content { 
                grid-template-columns: 1fr; 
                padding: 15px; 
                gap: 15px; 
            }
            .chart-card { 
                min-height: 300px; 
            }
            #header { 
                padding: 0 15px; 
                height: 56px;
            }
            .brand-btn { 
                padding: 6px 12px;
                font-size: 1rem;
            }
            .brand-span { 
                display: inline; 
                font-size: 0.9rem;
            }

            /* Convert Controls Bar to Bottom Sheet */
            #controls-bar {
                position: fixed; 
                bottom: 0; 
                left: 0; 
                right: 0;
                height: auto; 
                padding: 20px 15px 25px;
                border-radius: 20px 20px 0 0;
                box-shadow: 0 -8px 32px rgba(0,0,0,0.7);
                flex-direction: column; 
                gap: 15px; 
                align-items: stretch;
                transform: translateY(100%); /* Hidden by default */
                max-height: 80vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            #controls-bar.open { transform: translateY(0); }
            
            /* Drag Handle for visual cue */
            #controls-bar::before {
                content: ''; 
                display: block; 
                width: 40px; 
                height: 4px; 
                background: #334155; 
                margin: -10px auto 15px auto; 
                border-radius: 2px;
            }

            .zoom-group { 
                justify-content: flex-start;
                padding-bottom: 5px;
            }
            .zoom-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
                min-width: 40px;
                min-height: 40px;
            }
            
            .switch-wrapper { 
                justify-content: space-between; 
                background: rgba(255,255,255,0.05); 
                padding: 12px 15px; 
                border-radius: 10px; 
            }

            /* Mobile FAB to toggle controls */
            #mobile-fab {
                display: flex;
            }
            
            /* Hide FAB when chart is fullscreen */
            body.is-fullscreen #mobile-fab { display: none; }
            body.is-fullscreen #header { transform: translateY(-100%); }
            body.is-fullscreen #controls-bar { transform: translateY(100%); }
            
            /* Fullscreen card adjustments */
            .chart-card.fullscreen {
                padding: 15px;
            }
            .chart-card.fullscreen .chart-header {
                margin-top: 0;
                padding-top: env(safe-area-inset-top, 0px);
            }
            
            /* Prevent zoom on mobile */
            input, select, textarea {
                font-size: 16px; /* Prevents iOS zoom */
            }
        }

        @media (max-width: 480px) {
            .chart-card {
                min-height: 280px;
            }
            .zoom-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
                min-width: 36px;
                min-height: 36px;
            }
            .brand-span {
                font-size: 0.85rem;
            }
            select#sheetSelector {
                min-width: 120px;
                font-size: 0.85rem;
            }
        }

        /* Better touch targets on mobile */
        @media (hover: none) and (pointer: coarse) {
            button, .zoom-btn, .expand-btn, .brand-btn {
                min-height: 44px;
                min-width: 44px;
            }
        }

        /* Prevent text selection */
        button, .zoom-btn {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
    </style>

    <!-- Highcharts Theme -->
    <script>
        Highcharts.setOptions({
            global: {
                // FIXED: Use local time instead of UTC to ensure correct display
                useUTC: false 
            },
            chart: {
                backgroundColor: 'transparent',
                style: { fontFamily: "'Inter', sans-serif" },
                animation: false
            },
            colors: ['#3b82f6', '#22c55e', '#f97316', '#a855f7'],
            title: { style: { color: '#f1f5f9' } },
            legend: {
                itemStyle: { color: '#94a3b8' },
                itemHoverStyle: { color: '#f1f5f9' },
                itemDistance: 20
            },
            xAxis: {
                gridLineColor: '#1e293b',
                lineColor: '#334155',
                tickColor: '#334155',
                labels: { 
                    style: { color: '#64748b' },
                    autoRotation: [-45],
                    // FIXED: Display time correctly on axis
                    format: '{value:%H:%M}' 
                },
                minRange: 3600000 // 1 hour minimum
            },
            yAxis: {
                gridLineColor: '#1e293b',
                labels: { style: { color: '#64748b' } },
                title: { style: { color: '#64748b' } }
            },
            rangeSelector: {
                buttonTheme: {
                    fill: '#0f172a',
                    stroke: '#334155',
                    style: { color: '#94a3b8' },
                    states: {
                        hover: { fill: '#1e293b', style: { color: '#f1f5f9' } },
                        select: { fill: '#3b82f6', style: { color: 'white' } }
                    }
                },
                inputBoxBorderColor: '#334155',
                inputStyle: { color: '#94a3b8', backgroundColor: '#0f172a' },
                labelStyle: { color: '#64748b' },
                enabled: false
            },
            navigator: {
                maskFill: 'rgba(59, 130, 246, 0.2)',
                series: { color: '#3b82f6', lineWidth: 1 },
                outlineColor: '#334155',
                xAxis: { 
                    gridLineColor: '#1e293b', 
                    labels: { style: { color: '#64748b' } } 
                }
            },
            scrollbar: {
                barBackgroundColor: '#334155',
                trackBackgroundColor: '#0f172a',
                trackBorderColor: '#334155',
                enabled: window.innerWidth > 480
            },
            tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                style: { color: '#f1f5f9' },
                borderColor: '#334155',
                borderRadius: 8,
                useHTML: true,
                padding: 10,
                // FIXED: Format date exactly as requested: yyyy-MM-dd HH:mm:ss
                xDateFormat: '%Y-%m-%d %H:%M:%S'
            },
            credits: { enabled: false },
            plotOptions: {
                series: {
                    marker: {
                        enabled: false,
                        states: {
                            hover: {
                                enabled: true,
                                radius: 5
                            }
                        }
                    },
                    states: {
                        hover: {
                            halo: {
                                size: 0
                            }
                        }
                    }
                }
            }
        });
    </script>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxH13m5DXcyBH2BZ0qp1H3GovZCXEDRbjnD5yzj_KZL3O_MAGXG9PKu8dQdyDHhX0Vi_A/exec";
        
        var chartInstances = {}; // Stores Highcharts instances
        var currentSheetName = "";
        var latestSheetName = "";
        var allData = [];
        var isChartLoading = false;
        var liveSyncInterval = null;
        var lastDate = 0;
        var currentZoom = 24; // Default zoom in hours

        // Configuration
        const chartGroups = [
            { id: 'chart_main', title: 'Power & Cost', type: 'area', sA: {k:'pow', n:'Power', u:'W', c:'#f97316'}, sB: {k:'cost', n:'Cost', u:'₦', c:'#22c55e'}, icon: 'fa-bolt' },
            { id: 'chart_grid', title: 'Grid Stability', type: 'line', sA: {k:'vol', n:'Voltage', u:'V', c:'#3b82f6'}, sB: {k:'freq', n:'Freq', u:'Hz', c:'#14b8a6'}, icon: 'fa-wave-square' },
            { id: 'chart_load', title: 'Load Profile', type: 'line', sA: {k:'cur', n:'Current', u:'A', c:'#a855f7'}, sB: {k:'pf', n:'PF', u:'', c:'#6366f1'}, icon: 'fa-flux-capacitor' },
            { id: 'chart_env', title: 'Environment', type: 'line', sA: {k:'temp', n:'Temp', u:'°C', c:'#ef4444'}, sB: {k:'eng', n:'Energy', u:'kWh', c:'#eab308'}, icon: 'fa-temperature-half' }
        ];

        $(document).ready(function () { 
            initApp(); 
            initZoomButtons();
            
            // Close popup when clicking outside
            document.getElementById('dashboard-content').addEventListener('click', (e) => {
                if(window.innerWidth <= 768 && !e.target.closest('#controls-bar')) {
                    document.getElementById('controls-bar').classList.remove('open');
                }
            });
            
            // Handle window resize
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    Object.values(chartInstances).forEach(chart => {
                        if(chart) chart.reflow();
                    });
                }, 250);
            });
            
            // Prevent zoom on double-tap
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        });

        function toggleMobileControls() {
            const controls = document.getElementById('controls-bar');
            const isOpen = controls.classList.contains('open');
            
            if (isOpen) { 
                controls.classList.remove('open'); 
            } else { 
                controls.classList.add('open'); 
            }
            
            // Close keyboard if open
            document.activeElement.blur();
        }

        function toggleFullscreen(cardId) {
            const card = document.getElementById(cardId);
            const icon = card.querySelector('.expand-btn i');
            const isFull = card.classList.contains('fullscreen');

            // Reset other expanded cards
            document.querySelectorAll('.chart-card.fullscreen').forEach(c => {
                if(c.id !== cardId) {
                    c.classList.remove('fullscreen');
                    c.querySelector('.expand-btn i').className = 'fa-solid fa-expand';
                }
            });

            if (isFull) {
                card.classList.remove('fullscreen');
                document.body.classList.remove('is-fullscreen');
                icon.className = 'fa-solid fa-expand';
                document.body.style.overflow = 'auto'; 
            } else {
                card.classList.add('fullscreen');
                document.body.classList.add('is-fullscreen');
                icon.className = 'fa-solid fa-compress';
                document.body.style.overflow = 'hidden'; 
                document.getElementById('controls-bar').classList.remove('open'); 
            }

            // Force Chart Reflow for resize
            setTimeout(() => { 
                let chartId = card.querySelector('.chart-body').id;
                if(chartInstances[chartId]) {
                    chartInstances[chartId].reflow();
                    // Reapply current zoom
                    if(allData.length > 0) {
                        const max = allData[allData.length - 1].ts;
                        const min = currentZoom === 0 ? allData[0].ts : max - (currentZoom * 3600 * 1000);
                        chartInstances[chartId].xAxis[0].setExtremes(min, max);
                    }
                }
            }, 300);
        }

        function initApp() {
            setLoading(true, "Connecting...");
            $.ajax({
                url: `${GOOGLE_SCRIPT_URL}?action=getDashboardState`,
                dataType: 'json', 
                timeout: 30000, 
                success: function(res) {
                    if(res.success && res.sheets.length > 0) {
                        populateSheetSelector(res.sheets);
                        latestSheetName = res.sheets[0];
                        loadChartData(res.sheets[0]);
                    } else {
                        showError("No data found.");
                        setLoading(false);
                    }
                },
                error: function(e) { 
                    showError("Connection Failed. Please check your internet connection."); 
                    setLoading(false); 
                }
            });
        }

        function initZoomButtons() {
            const container = document.getElementById('zoom-controls');
            // Added "All" button
            const zooms = [
                {h:1,l:'1H'}, 
                {h:6,l:'6H'}, 
                {h:12,l:'12H'}, 
                {h:24,l:'1D', default: true}, 
                {h:72,l:'3D'}, 
                {h:168,l:'1W'}, 
                {h:720,l:'1M'}, 
                {h:0,l:'All'}
            ];
            container.innerHTML = "";
            zooms.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = `zoom-btn ${opt.default ? 'active' : ''}`;
                btn.textContent = opt.l;
                btn.title = opt.h === 0 ? 'Show all data' : `Show last ${opt.h} hours`;
                btn.onclick = (e) => {
                    e.stopPropagation();
                    setZoom(opt.h, btn);
                };
                container.appendChild(btn);
            });
        }

        function setZoom(hours, btn) {
            document.querySelectorAll('.zoom-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            currentZoom = hours;
            
            if (allData.length > 0) {
                const max = allData[allData.length - 1].ts;
                let min;
                
                if (hours === 0) {
                    // Show all data
                    min = allData[0].ts;
                } else {
                    min = max - (hours * 3600 * 1000);
                    // Ensure we don't go before the first data point
                    if (min < allData[0].ts) {
                        min = allData[0].ts;
                    }
                }

                // Update all charts without reloading data
                chartGroups.forEach(def => {
                    if(chartInstances[def.id]) {
                        chartInstances[def.id].xAxis[0].setExtremes(min, max, true);
                    }
                });
            }
        }

        function populateSheetSelector(sheets) {
            const sel = document.getElementById('sheetSelector');
            sel.innerHTML = "";
            sheets.forEach(s => { 
                let o = document.createElement('option'); 
                o.value = s; 
                o.text = s; 
                sel.appendChild(o); 
            });
            sel.onchange = (e) => {
                loadChartData(e.target.value);
                // Close keyboard on mobile
                if(window.innerWidth <= 768) {
                    e.target.blur();
                }
            };
        }

        function loadChartData(sheetName) {
            if(isChartLoading) return;
            isChartLoading = true;
            currentSheetName = sheetName;
            setLoading(true, `Loading ${sheetName}...`);
            document.getElementById('no-data-msg').style.display = 'none';

            // Clear existing charts
            Object.values(chartInstances).forEach(chart => {
                if(chart) chart.destroy();
            });
            chartInstances = {};
            
            $.ajax({
                url: `${GOOGLE_SCRIPT_URL}?action=getMonthData&sheet=${encodeURIComponent(sheetName)}`,
                dataType: 'json', 
                timeout: 60000,
                success: function(res) {
                    if (!res.success) { 
                        showError(res.error || "Failed to load data"); 
                        return; 
                    }
                    if (!res.data || res.data.length === 0) {
                        document.getElementById('no-data-msg').style.display = 'flex';
                        clearCharts();
                        return;
                    }
                    
                    // Process data
                    allData = res.data.map(d => {
                        let ts = (typeof d.ts === 'string') ? parseCustomDate(d.ts) : d.ts;
                        return { 
                            ts: ts, 
                            vol: d.vol !== undefined && d.vol !== null ? Number(d.vol) : undefined,
                            cur: d.cur !== undefined && d.cur !== null ? Number(d.cur) : undefined,
                            pow: d.pow !== undefined && d.pow !== null ? Number(d.pow) : undefined,
                            freq: d.freq !== undefined && d.freq !== null ? Number(d.freq) : undefined,
                            pf: d.pf !== undefined && d.pf !== null ? Number(d.pf) : undefined,
                            temp: d.temp !== undefined && d.temp !== null ? Number(d.temp) : undefined,
                            eng: d.eng !== undefined && d.eng !== null ? Number(d.eng) : undefined,
                            cost: d.cost !== undefined && d.cost !== null ? Number(d.cost) : undefined
                        };
                    }).sort((a,b) => a.ts - b.ts);

                    if (allData.length > 0) lastDate = allData[allData.length - 1].ts;

                    createCharts(allData);
                    startLiveSync();
                },
                error: function(e) { 
                    showError("Load Failed. Please try again."); 
                },
                complete: function() { 
                    setLoading(false); 
                    isChartLoading = false; 
                }
            });
        }

        function createCharts(data) {
            chartGroups.forEach(def => {
                renderSingleChart(def, data);
            });
            
            // Apply default zoom (1 Day)
            if(data.length > 0) {
                const max = data[data.length-1].ts;
                const min = max - (24 * 3600 * 1000);
                chartGroups.forEach(def => {
                     if(chartInstances[def.id]) {
                        chartInstances[def.id].xAxis[0].setExtremes(min, max);
                     }
                });
                
                // Update active zoom button
                const activeBtn = document.querySelector('.zoom-btn[title*="1D"]');
                if(activeBtn) {
                    document.querySelectorAll('.zoom-btn').forEach(b => b.classList.remove('active'));
                    activeBtn.classList.add('active');
                }
            }
        }

        function renderSingleChart(def, data) {
            const sA = def.sA; 
            const sB = def.sB;

            // Filter out undefined/null values
            const seriesDataA = data
                .filter(d => d[sA.k] !== undefined)
                .map(d => [d.ts, d[sA.k]]);
                
            const seriesDataB = data
                .filter(d => d[sB.k] !== undefined)
                .map(d => [d.ts, d[sB.k]]);

            // Create or update chart
            if (chartInstances[def.id]) {
                // Update existing chart
                chartInstances[def.id].series[0].setData(seriesDataA, false);
                chartInstances[def.id].series[1].setData(seriesDataB, false);
                chartInstances[def.id].redraw();
            } else {
                // Initialize Highstock
                chartInstances[def.id] = Highcharts.stockChart(def.id, {
                    chart: { 
                        type: def.type === 'area' ? 'area' : 'spline',
                        alignTicks: false,
                        events: {
                            load: function() {
                                // Set initial zoom if needed
                                if(allData.length > 0 && currentZoom !== undefined) {
                                    const max = allData[allData.length-1].ts;
                                    const min = currentZoom === 0 ? allData[0].ts : max - (currentZoom * 3600 * 1000);
                                    this.xAxis[0].setExtremes(min, max);
                                }
                            }
                        }
                    },
                    rangeSelector: { enabled: false },
                    
                    yAxis: [{
                        // --- LEFT AXIS (Series A) ---
                        labels: {
                            align: 'right',
                            x: -10,
                            format: '{value} ' + sA.u,
                            style: { color: sA.c }
                        },
                        title: {
                            text: sA.n,
                            style: { color: sA.c }
                        },
                        height: '100%',
                        lineWidth: 1,
                        lineColor: sA.c,
                        opposite: false,
                        offset: 0,
                        showEmpty: false
                    }, {
                        // --- RIGHT AXIS (Series B) ---
                        labels: {
                            align: 'left',
                            x: 10,
                            format: '{value} ' + sB.u,
                            style: { color: sB.c }
                        },
                        title: {
                            text: sB.n,
                            style: { color: sB.c }
                        },
                        top: 0,
                        height: '100%',
                        offset: 0,
                        lineWidth: 1,
                        lineColor: sB.c,
                        opposite: true,
                        showEmpty: false
                    }],
                    
                    series: [{
                        name: sA.n,
                        data: seriesDataA,
                        color: sA.c,
                        yAxis: 0,
                        tooltip: { 
                            valueDecimals: 2, 
                            valueSuffix: ' ' + sA.u 
                        },
                        fillOpacity: def.type === 'area' ? 0.1 : 0
                    }, {
                        name: sB.n,
                        data: seriesDataB,
                        color: sB.c,
                        yAxis: 1,
                        tooltip: { 
                            valueDecimals: 2, 
                            valueSuffix: ' ' + sB.u 
                        },
                        dashStyle: def.type === 'line' ? 'ShortDot' : 'Solid'
                    }],

                    legend: { 
                        enabled: true, 
                        align: 'center', 
                        verticalAlign: 'top', 
                        y: 0, 
                        floating: true,
                        backgroundColor: 'rgba(15, 23, 42, 0.8)',
                        borderColor: '#334155',
                        borderRadius: 8
                    },
                    
                    navigator: {
                        enabled: true,
                        height: 35,
                        margin: 10
                    },
                    
                    scrollbar: {
                        enabled: window.innerWidth > 480
                    }
                });
            }
        }

        function clearCharts() {
            Object.values(chartInstances).forEach(c => {
                if(c) {
                    c.series.forEach(s => s.setData([]));
                }
            });
        }

        function startLiveSync() {
            if (liveSyncInterval) clearInterval(liveSyncInterval);
            if (currentSheetName === latestSheetName && document.getElementById("liveToggle").checked) {
                liveSyncInterval = setInterval(liveSync, 15000);
            }
        }

        function liveSync() {
            if (!document.getElementById("liveToggle").checked || isChartLoading || currentSheetName !== latestSheetName) return;
            $.getJSON(`${GOOGLE_SCRIPT_URL}?action=getDashboardState`, function(res) {
                if(res.success && res.latest) {
                    const l = res.latest;
                    const serverTs = (typeof l.ts === 'number') ? l.ts : parseCustomDate(l.ts);

                    if (serverTs > lastDate) {
                        lastDate = serverTs;
                        
                        const pt = { 
                            ts: serverTs, 
                            vol: l.vol !== undefined ? Number(l.vol) : undefined, 
                            cur: l.cur !== undefined ? Number(l.cur) : undefined, 
                            pow: l.pow !== undefined ? Number(l.pow) : undefined, 
                            freq: l.freq !== undefined ? Number(l.freq) : undefined, 
                            pf: l.pf !== undefined ? Number(l.pf) : undefined, 
                            temp: l.temp !== undefined ? Number(l.temp) : undefined, 
                            eng: l.monthEng !== undefined ? Number(l.monthEng) : undefined, 
                            cost: l.monthCost !== undefined ? Number(l.monthCost) : undefined 
                        };
                        allData.push(pt);
                        
                        // Add point to each Highchart
                        chartGroups.forEach(def => {
                            if(chartInstances[def.id]) {
                                const shift = chartInstances[def.id].series[0].data.length > 2000;
                                if(pt[def.sA.k] !== undefined) {
                                    chartInstances[def.id].series[0].addPoint([serverTs, pt[def.sA.k]], true, shift);
                                }
                                if(pt[def.sB.k] !== undefined) {
                                    chartInstances[def.id].series[1].addPoint([serverTs, pt[def.sB.k]], true, shift);
                                }
                            }
                        });
                    }
                }
            }).fail(function() {
                console.warn("Live sync failed");
            });
        }

        function parseCustomDate(dateStr) {
            if(typeof dateStr !== 'string') return new Date().getTime();
            
            // Try multiple date formats
            // Updated regex to catch yyyy-MM-dd HH:mm:ss more reliably
            const formats = [
                /(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})/,  // yyyy-MM-dd HH:mm:ss
                /(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2}):(\d{2})/, // dd/MM/yyyy HH:mm:ss
                /(\d{2})-(\d{2})-(\d{4}) (\d{2}):(\d{2}):(\d{2})/   // mm-dd-yyyy HH:mm:ss
            ];
            
            for(let format of formats) {
                const match = dateStr.match(format);
                if(match) {
                    if(format === formats[0]) {
                        // yyyy-mm-dd
                        return new Date(match[1], match[2]-1, match[3], match[4], match[5], match[6]).getTime();
                    } else if(format === formats[1]) {
                        // dd/mm/yyyy
                        return new Date(match[3], match[2]-1, match[1], match[4], match[5], match[6]).getTime();
                    } else {
                        // mm-dd-yyyy
                        return new Date(match[3], match[1]-1, match[2], match[4], match[5], match[6]).getTime();
                    }
                }
            }
            
            // Fallback to Date.parse
            const parsed = Date.parse(dateStr);
            return isNaN(parsed) ? new Date().getTime() : parsed;
        }

        function setLoading(state, msg) {
            const loader = document.getElementById('loader');
            if(loader) {
                loader.style.display = state ? 'flex' : 'none';
                if(msg && document.getElementById('loader-text')) {
                    document.getElementById('loader-text').innerText = msg;
                }
            }
        }
        
        function showError(msg) {
            // Create error message element if it doesn't exist
            let errorMsg = document.getElementById('error-message');
            if(!errorMsg) {
                errorMsg = document.createElement('div');
                errorMsg.id = 'error-message';
                errorMsg.className = 'status-msg';
                document.getElementById('dashboard-content').appendChild(errorMsg);
            }
            errorMsg.innerHTML = `<i class="fa-solid fa-triangle-exclamation fa-2x" style="margin-bottom:10px; color:#ef4444;"></i><br>${msg}`;
            errorMsg.style.display = 'block';
        }

        // Live toggle event listener
        document.getElementById('liveToggle').addEventListener('change', function() {
            if (this.checked) {
                startLiveSync();
            } else {
                if (liveSyncInterval) { 
                    clearInterval(liveSyncInterval); 
                    liveSyncInterval = null; 
                }
            }
        });
        
        // Prevent context menu on mobile
        document.addEventListener('contextmenu', function(e) {
            if(window.innerWidth <= 768) {
                e.preventDefault();
            }
        });
    </script>
</head>
<body>

    <div id="loader" class="overlay">
        <div class="spinner"></div>
        <p id="loader-text" style="margin-top:15px; font-size:0.9rem; color:#94a3b8;">Initializing...</p>
    </div>

    <div id="header">
        <a href="index.html" class="brand-btn"><i class="fa-solid fa-chevron-left"></i><span class="brand-span">WaliTech | Chart Analytics</span></a>
        <select id="sheetSelector"><option>Loading...</option></select>
    </div>

    <div id="dashboard-content">
        <div id="no-data-msg">
            <i class="fa-regular fa-folder-open fa-3x" style="opacity:0.5; margin-bottom:10px;"></i>
            <span>No Data Found</span>
        </div>

        <!-- 1. Power & Cost -->
        <div class="chart-card full-span" id="card_main">
            <div class="chart-header">
                <div class="chart-title">Power & Consumption</div>
                <div class="card-actions">
                    <i class="fa-solid fa-bolt" style="color:#f97316;"></i>
                    <div class="expand-btn" onclick="toggleFullscreen('card_main')">
                        <i class="fa-solid fa-expand"></i>
                    </div>
                </div>
            </div>
            <div id="chart_main" class="chart-body"></div>
        </div>

        <!-- 2. Grid Stability -->
        <div class="chart-card full-span" id="card_grid">
            <div class="chart-header">
                <div class="chart-title">Grid Stability</div>
                <div class="card-actions">
                    <i class="fa-solid fa-wave-square" style="color:#3b82f6;"></i>
                    <div class="expand-btn" onclick="toggleFullscreen('card_grid')">
                        <i class="fa-solid fa-expand"></i>
                    </div>
                </div>
            </div>
            <div id="chart_grid" class="chart-body"></div>
        </div>

        <!-- 3. Load Profile -->
        <div class="chart-card full-span" id="card_load">
            <div class="chart-header">
                <div class="chart-title">Load Profile</div>
                <div class="card-actions">
                    <i class="fa-solid fa-flux-capacitor" style="color:#a855f7;"></i>
                    <div class="expand-btn" onclick="toggleFullscreen('card_load')">
                        <i class="fa-solid fa-expand"></i>
                    </div>
                </div>
            </div>
            <div id="chart_load" class="chart-body"></div>
        </div>

        <!-- 4. Environment -->
        <div class="chart-card full-span" id="card_env">
            <div class="chart-header">
                <div class="chart-title">Environment & Totals</div>
                <div class="card-actions">
                    <i class="fa-solid fa-temperature-half" style="color:#ef4444;"></i>
                    <div class="expand-btn" onclick="toggleFullscreen('card_env')">
                        <i class="fa-solid fa-expand"></i>
                    </div>
                </div>
            </div>
            <div id="chart_env" class="chart-body"></div>
        </div>
    </div>

    <button id="mobile-fab" onclick="toggleMobileControls()" title="Show/Hide Controls">
        <i class="fa-solid fa-sliders"></i>
    </button>

    <div id="controls-bar">
        <div id="zoom-controls" class="zoom-group"></div>
        <div class="switch-wrapper">
            <label class="switch"><input type="checkbox" id="liveToggle" checked><span class="slider"></span></label>
            <span>Live Sync</span>
        </div>
    </div>

</body>
</html>