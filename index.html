<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="WaliTech HomeMetrics Pro - Advanced Energy Monitoring Dashboard">
  <meta name="theme-color" content="#2563eb">
  <title>WaliTech HomeMetrics Pro</title>

  <!-- PWA Support -->
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡</text></svg>">

  <!-- Theme Detection -->
  <script>
    (function() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    })();
  </script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { 
        extend: { 
          colors: { 
            slate: { 750: '#293548', 850: '#1e293b', 950: '#0f172a' },
            primary: '#2563eb',
            secondary: '#10b981'
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'bounce-slow': 'bounce 2s infinite',
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-in': 'slideIn 0.3s ease-out'
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' }
            },
            slideIn: {
              '0%': { transform: 'translateY(-10px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' }
            }
          }
        } 
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    body { 
      font-family: 'Inter', sans-serif; 
      padding-top: env(safe-area-inset-top);
      -webkit-tap-highlight-color: transparent;
    }
    
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }
    
    .sidebar-link { 
      display: flex; 
      align-items: center; 
      padding: 12px 16px; 
      border-radius: 8px; 
      transition: all 0.2s; 
      cursor: pointer; 
      margin-bottom: 4px; 
      font-weight: 500; 
      user-select: none;
    }
    .sidebar-link:hover { background-color: #e2e8f0; color: #0f172a; }
    .dark .sidebar-link:hover { background-color: #334155; color: #f1f5f9; }
    .sidebar-link.active { 
      background-color: #2563eb; 
      color: white; 
      box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
    }
    
    .card { 
      border-radius: 12px; 
      padding: 16px; 
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); 
      position: relative; 
      transition: all 0.3s;
      backdrop-filter: blur(10px);
    }
    .card:hover {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    /* Fullscreen Card Logic */
    .fullscreen-card {
        position: fixed !important; 
        top: 0; 
        left: 0; 
        right: 0; 
        bottom: 0;
        z-index: 100; 
        border-radius: 0 !important; 
        margin: 0 !important;
        height: 100vh !important; 
        width: 100vw !important; 
        display: flex; 
        flex-direction: column;
        animation: fadeIn 0.3s ease-out;
    }
    .fullscreen-card .overflow-x-auto { 
      height: auto !important; 
      flex: 1; 
    }

    .status-badge { 
      display: inline-flex; 
      align-items: center; 
      padding: 6px 12px; 
      border-radius: 9999px; 
      font-weight: 700; 
      font-size: 0.75rem; 
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .status-on { 
      background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
      color: white; 
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }
    .status-off { 
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
      color: white;
      box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
    }
    .blink { animation: pulse 2s infinite; }
    @keyframes pulse { 
      0% { opacity: 1; } 
      50% { opacity: 0.4; } 
      100% { opacity: 1; } 
    }
    
    .mobile-menu-closed { transform: translateX(-100%); }
    .mobile-menu-open { transform: translateX(0); }
    
    .data-table th { 
      padding: 10px; 
      font-size: 0.75rem; 
      text-transform: uppercase; 
      position: sticky; 
      top: 0; 
      background: inherit; 
      z-index: 10; 
      letter-spacing: 0.05em;
    }
    .data-table td { 
      padding: 10px; 
      border-bottom-width: 1px; 
      font-size: 0.85rem; 
      transition: background-color 0.2s;
    }
    .data-table tr:hover td {
      background-color: rgba(59, 130, 246, 0.05);
    }
    .dark .data-table tr:hover td {
      background-color: rgba(59, 130, 246, 0.1);
    }
    
    .zoom-btn { 
      padding: 4px 10px; 
      border-radius: 6px; 
      font-size: 0.75rem; 
      font-weight: 600; 
      transition: all 0.2s; 
      border-width: 1px; 
      cursor: pointer;
      user-select: none;
    }
    .zoom-btn.active { 
      background: #2563eb; 
      color: white; 
      border-color: #2563eb;
      box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
    }
    
    .stat-label { 
      font-size: 0.7rem; 
      font-weight: 700; 
      text-transform: uppercase; 
      letter-spacing: 0.05em;
    }
    .stat-val { 
      font-size: 1.25rem; 
      font-weight: 800; 
      line-height: 1.2;
    }
    .stat-unit { 
      font-size: 0.75rem; 
      font-weight: 600; 
      margin-left: 2px; 
      opacity: 0.8;
    }
    .touch-action-none { touch-action: none; }
    
    .info-icon { 
      color: #94a3b8; 
      cursor: pointer; 
      transition: 0.2s; 
      margin-left: 8px; 
      font-size: 0.9rem; 
    }
    .info-icon:hover { color: #3b82f6; }

    /* Loading animations */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    .dark .skeleton {
      background: linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    @media (max-width: 768px) {
      .card { padding: 12px; }
      .stat-val { font-size: 1.1rem; }
      .chart-container { height: 250px !important; }
      #page-dashboard .grid-cols-5 { grid-template-columns: repeat(2, 1fr); }
      .sidebar-link { padding: 10px 14px; }
      .status-badge { font-size: 0.7rem; padding: 4px 8px; }
    }
  </style>
</head>

<body class="flex h-screen overflow-hidden text-slate-800 bg-slate-50 dark:bg-slate-900 dark:text-slate-200 transition-colors duration-300">

  <!-- INFO MODAL -->
  <div id="info-modal" class="hidden fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
      <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl max-w-sm w-full p-6 relative border border-slate-200 dark:border-slate-700 animate-fade-in">
          <button onclick="closeInfo()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors">
              <i class="fa-solid fa-xmark text-xl"></i>
          </button>
          <div class="flex items-center gap-3 mb-4">
              <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-full text-blue-600 dark:text-blue-400">
                  <i id="info-icon-display" class="fa-solid fa-circle-info text-xl"></i>
              </div>
              <h3 id="info-title" class="text-lg font-bold text-slate-800 dark:text-white">Info</h3>
          </div>
          <div id="info-content" class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed space-y-2"></div>
      </div>
  </div>

  <!-- TOAST NOTIFICATION -->
  <div id="toast" class="toast hidden bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
    <div class="flex items-center gap-2">
      <i id="toast-icon" class="fa-solid fa-circle-info text-blue-500"></i>
      <span id="toast-message" class="text-sm font-medium text-slate-700 dark:text-slate-300"></span>
    </div>
  </div>

  <script>
    // *** PASTE YOUR UPDATED GOOGLE SCRIPT URL HERE ***
    const API_URL = "https://script.google.com/macros/s/AKfycbxH13m5DXcyBH2BZ0qp1H3GovZCXEDRbjnD5yzj_KZL3O_MAGXG9PKu8dQdyDHhX0Vi_A/exec";

    // Mock Google Script API
    const google = {
      script: {
        run: {
          withSuccessHandler: function(onSuccess) {
            return {
              getDashboardState: () => callApi('getDashboardState', {}, onSuccess),
              getMonthData: (sheet) => callApi('getMonthData', {sheet: sheet}, onSuccess),
              getDetailedYearlyReport: () => callApi('getDetailedYearlyReport', {}, onSuccess),
              getYearlyGridStats: (year) => callApi('getYearlyGridStats', {year: year}, onSuccess),
              getAlertSettings: () => callApi('getAlertSettings', {}, onSuccess),
              getAlertLogs: () => callApi('getAlertLogs', {}, onSuccess),
              saveAlertSettings: (s) => callApi('saveAlertSettings', {data: JSON.stringify(s)}, onSuccess)
            };
          }
        }
      }
    };

    function callApi(action, params, callback) {
      const url = new URL(API_URL);
      url.searchParams.append("action", action);
      for (const key in params) {
        if (params[key] !== undefined && params[key] !== null) {
          url.searchParams.append(key, params[key]);
        }
      }
      
      // Show loading state
      if (action !== 'getDashboardState') {
        toggleLoader(true);
      }
      
      fetch(url)
        .then(r => r.json())
        .then(d => {
          if (callback) callback(d);
          toggleLoader(false);
        })
        .catch(e => {
          console.error("API Error", e);
          showToast('Connection error. Please check your network.', 'error');
          toggleLoader(false);
        });
    }

    // Toast notification function
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const toastIcon = document.getElementById('toast-icon');
      const toastMessage = document.getElementById('toast-message');
      
      // Set icon based on type
      const icons = {
        'success': 'fa-circle-check text-green-500',
        'error': 'fa-circle-exclamation text-red-500',
        'warning': 'fa-triangle-exclamation text-yellow-500',
        'info': 'fa-circle-info text-blue-500'
      };
      
      toastIcon.className = `fa-solid ${icons[type]}`;
      toastMessage.textContent = message;
      
      // Show toast
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('show'), 10);
      
      // Hide after 3 seconds
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.classList.add('hidden'), 300);
      }, 3000);
    }
  </script>

  <div id="main-loader" class="hidden absolute inset-0 z-50 bg-white/70 dark:bg-slate-900/70 backdrop-blur-sm flex items-center justify-center">
    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 flex items-center gap-3">
      <i class="fa-solid fa-circle-notch fa-spin text-blue-600 text-2xl"></i>
      <span class="font-bold text-slate-700 dark:text-slate-200">Processing...</span>
    </div>
  </div>

  <div id="mobile-overlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden"></div>

  <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-white/80 dark:bg-slate-800/80 backdrop-blur-md border-r border-slate-200 dark:border-slate-700 flex flex-col z-30 transition-all duration-300 ease-in-out mobile-menu-closed md:relative md:translate-x-0 md:w-64">
    <div class="h-16 flex items-center px-6 border-b border-slate-100 dark:border-slate-700 justify-between">
      <div class="flex items-center gap-2">
        <i class="fa-solid fa-bolt text-blue-600 text-xl"></i>
        <span class="font-bold text-lg text-slate-800 dark:text-white">WaliTech</span>
        <span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400 px-2 py-1 rounded-full">Pro</span>
      </div>
      <button onclick="toggleMobileMenu()" class="md:hidden text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors">
        <i class="fa-solid fa-xmark text-xl"></i>
      </button>
    </div>
    
    <div class="p-4 flex-1 overflow-y-auto text-slate-600 dark:text-slate-400">
      <p class="px-4 text-xs font-bold text-slate-400 uppercase mb-2 mt-2">Monitoring</p>
      <a onclick="showPage('dashboard')" id="nav-dashboard" class="sidebar-link active">
        <i class="fa-solid fa-gauge w-5 mr-3"></i> Dashboard
      </a>
      
      <p class="px-4 text-xs font-bold text-slate-400 uppercase mb-2 mt-6">Charts</p>
      <a href="Chart.html" class="sidebar-link">
        <i class="fa-solid fa-chart-pie w-5 mr-3"></i> Chart
      </a>
      <div onclick="toggleChartsMenu()" class="sidebar-link justify-between cursor-pointer select-none">
        <div class="flex items-center">
          <i class="fa-solid fa-chart-line w-5 mr-3"></i> Chart Analysis
        </div>
        <i id="charts-arrow" class="fa-solid fa-chevron-down text-xs transition-transform duration-200"></i>
      </div>
      <div id="charts-submenu" class="hidden flex-col pl-9 pr-2 space-y-1 mb-2">
        <a href="Historical_Single-Axis_Chart.html" class="block py-2 px-3 text-sm rounded-lg text-slate-500 hover:text-slate-900 hover:bg-slate-200 dark:text-slate-400 dark:hover:text-white dark:hover:bg-slate-700 transition">
          Historical Single-Axis Chart
        </a>
        <a href="Historical_Multi-Axis_Chart.html" class="block py-2 px-3 text-sm rounded-lg text-slate-500 hover:text-slate-900 hover:bg-slate-200 dark:text-slate-400 dark:hover:text-white dark:hover:bg-slate-700 transition">
          Historical Multi-Axis Chart
        </a>
      </div>
      
      <p class="px-4 text-xs font-bold text-slate-400 uppercase mb-2 mt-6">Reports</p>
      <a onclick="showPage('analysis')" id="nav-analysis" class="sidebar-link">
        <i class="fa-solid fa-magnifying-glass-chart w-5 mr-3"></i> Smart Analysis
      </a>
      <a href="monthly_report.html" class="sidebar-link">
        <i class="fa-solid fa-calendar-days w-5 mr-3"></i> Monthly Report
      </a>
      <a onclick="showPage('yearly')" id="nav-yearly" class="sidebar-link">
        <i class="fa-solid fa-calendar-days w-5 mr-3"></i> Yearly Report
      </a>
      
      <p class="px-4 text-xs font-bold text-slate-400 uppercase mb-2 mt-6">System</p>
      <a onclick="showPage('alerts')" id="nav-alerts" class="sidebar-link">
        <i class="fa-solid fa-bell w-5 mr-3"></i> Settings & Alerts
      </a> 
      <a href="https://oz-786.github.io/DashBoard_HomeMetric/" class="sidebar-link" target="_blank">
        <i class="fa-solid fa-microchip w-5 mr-3"></i> Old Dashboard
      </a>
    </div>
    
    <div class="p-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50">
      <button onclick="toggleTheme()" class="w-full mb-4 border border-slate-300 dark:border-slate-600 rounded-lg py-2 text-sm font-bold flex items-center justify-center gap-2 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition">
        <i class="fa-solid fa-moon"></i> <span>Theme</span>
      </button>
      <div class="flex items-center justify-between mb-1">
        <span class="text-xs font-bold text-slate-500">SYSTEM STATUS</span>
        <button onclick="refreshData()" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition-colors">
          <i class="fa-solid fa-rotate"></i>
        </button>
      </div>
      <div id="side-status-text" class="text-sm font-bold text-slate-400">Checking...</div>
      <div class="text-xs text-slate-400 mt-2">
        <i class="fa-solid fa-circle-info mr-1"></i>
        <span id="side-last-update">Last update: --</span>
      </div>
    </div>
  </aside>

  <main id="main-content" class="flex-1 flex flex-col min-w-0 relative bg-slate-50 dark:bg-slate-900 transition-colors duration-300 overflow-auto touch-action-none">

    <header class="h-16 bg-white/80 dark:bg-slate-800/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-4 z-10 sticky top-0 transition-colors duration-300">
      <div class="flex items-center gap-3">
        <button id="mobile-menu-toggle" onclick="toggleMobileMenu()" class="md:hidden text-slate-500 hover:text-blue-600 transition p-1">
          <i class="fa-solid fa-bars text-xl"></i>
        </button>
        <h1 class="text-lg font-bold text-slate-800 dark:text-white" id="page-title">Dashboard</h1>
      </div>
      <div class="flex items-center gap-3">
        <div id="selector-container" class="hidden">
          <select id="sheetSelector" onchange="fetchMonthData()" class="bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-white text-sm rounded-lg p-2 outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
            <option>Loading...</option>
          </select>
        </div>
        <div id="top-status-badge" class="status-badge status-off flex items-center">
          <i class="fa-solid fa-circle text-[6px] mr-2"></i> OFFLINE
        </div>
      </div>
    </header>

    <div class="flex-1 overflow-y-auto p-3 sm:p-4 md:p-6 scroll-smooth relative">
      
      <!-- 1. DASHBOARD -->
      <div id="page-dashboard" class="space-y-4 md:space-y-6 animate-fade-in">
        <div class="flex justify-between items-start md:items-end mb-4 flex-col md:flex-row gap-2">
          <div>
            <h2 class="text-xl md:text-2xl font-bold text-slate-900 dark:text-white">Live Overview</h2>
            <p class="text-sm text-slate-500 dark:text-slate-400">Real-time parameters from your energy monitoring system</p>
          </div>
          <div class="text-left md:text-right">
            <div class="text-xs font-bold text-slate-400 uppercase">Last Data</div>
            <div id="last-updated-main" class="text-sm font-mono font-bold text-blue-600 dark:text-blue-400">--</div>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-4 md:grid-cols-2 md:gap-6 mb-4 md:mb-6">
          <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 backdrop-blur-sm">
            <div class="flex justify-between items-center mb-2">
              <h3 class="font-bold text-slate-700 dark:text-slate-200">Monthly Budget</h3>
              <span class="text-xs font-bold text-slate-400" id="budget-text">0% Used</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-4 dark:bg-slate-700 overflow-hidden">
              <div id="budget-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="flex justify-between mt-2 text-xs">
              <span id="curr-spend" class="font-bold text-slate-600 dark:text-slate-400">₦0</span>
              <span class="text-slate-400">Target: ₦<span id="budget-target-display">50,000</span></span>
            </div>
          </div>
          
          <div class="card bg-emerald-50/50 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-800 backdrop-blur-sm flex items-center justify-between">
            <div>
              <div class="flex items-center gap-1">
                <div class="text-xs font-bold text-emerald-600 dark:text-emerald-400 uppercase">Carbon Footprint</div>
                <i class="fa-solid fa-circle-info info-icon" onclick="showInfo('carbon')"></i>
              </div>
              <div class="text-xl md:text-2xl font-bold text-emerald-800 dark:text-emerald-200">
                <span id="co2-val">0</span> <span class="text-sm">kg</span>
              </div>
              <div class="text-xs text-emerald-600 dark:text-emerald-400 mt-1">
                <i class="fa-solid fa-tree"></i> Offset by <span id="tree-val">0</span> trees
              </div>
            </div>
            <i class="fa-solid fa-leaf text-3xl md:text-4xl text-emerald-200 dark:text-emerald-800 opacity-60"></i>
          </div>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-4">
          <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 border-l-4 border-l-blue-500 backdrop-blur-sm">
            <div class="flex items-center justify-between">
              <div class="stat-label text-slate-400">Voltage</div>
              <i class="fa-solid fa-circle-info info-icon" onclick="showInfo('voltage')"></i>
            </div>
            <div class="stat-val text-slate-800 dark:text-white">
              <span id="d-vol">0</span><span class="stat-unit text-slate-500">V</span>
            </div>
          </div>
          
          <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 border-l-4 border-l-purple-500 backdrop-blur-sm">
            <div class="stat-label text-slate-400">Current</div>
            <div class="stat-val text-slate-800 dark:text-white">
              <span id="d-cur">0</span><span class="stat-unit text-slate-500">A</span>
            </div>
          </div>
          
          <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 border-l-4 border-l-orange-500 backdrop-blur-sm">
            <div class="stat-label text-slate-400">Power</div>
            <div class="stat-val text-slate-800 dark:text-white">
              <span id="d-pow">0</span><span class="stat-unit text-slate-500">W</span>
            </div>
          </div>
          
          <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 border-l-4 border-l-teal-500 backdrop-blur-sm">
            <div class="stat-label text-slate-400">Frequency</div>
            <div class="stat-val text-slate-800 dark:text-white">
              <span id="d-freq">0</span><span class="stat-unit text-slate-500">Hz</span>
            </div>
          </div>
          
          <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 border-l-4 border-l-indigo-500 backdrop-blur-sm">
            <div class="flex items-center justify-between">
              <div class="stat-label text-slate-400">Power Factor</div>
              <i class="fa-solid fa-circle-info info-icon" onclick="showInfo('pf')"></i>
            </div>
            <div class="stat-val text-slate-800 dark:text-white">
              <span id="d-pf">0.00</span>
            </div>
          </div>

          <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 border-l-4 border-l-yellow-500 backdrop-blur-sm">
            <div class="stat-label text-slate-400">Month Energy</div>
            <div class="stat-val text-slate-800 dark:text-white">
              <span id="d-m-eng">0</span><span class="stat-unit text-slate-500">kWh</span>
            </div>
          </div>
          
          <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 border-l-4 border-l-green-500 backdrop-blur-sm">
            <div class="stat-label text-slate-400">Month Cost</div>
            <div class="stat-val text-green-600 dark:text-green-400" id="d-m-cost">₦0.00</div>
          </div>
          
          <div class="card bg-slate-800/50 dark:bg-slate-700/50 border border-slate-600 text-white backdrop-blur-sm">
            <div class="stat-label text-slate-300">Projected Bill</div>
            <div class="stat-val text-white" id="d-pred-cost">...</div>
            <div class="text-xs text-slate-300 mt-1" id="d-pred-desc">Calculating...</div>
          </div>
          
          <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 border-l-4 border-l-yellow-600 backdrop-blur-sm">
            <div class="stat-label text-slate-400">Year Energy</div>
            <div class="stat-val text-slate-800 dark:text-white">
              <span id="d-y-eng">0</span><span class="stat-unit text-slate-500">kWh</span>
            </div>
          </div>
          
          <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 border-l-4 border-l-green-700 backdrop-blur-sm">
            <div class="stat-label text-slate-400">Year Cost</div>
            <div class="stat-val text-green-800 dark:text-green-500" id="d-y-cost">₦0.00</div>
          </div>
        </div>
        
        <!-- Additional Dashboard Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
          <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 backdrop-blur-sm">
            <div class="flex items-center justify-between mb-2">
              <div class="stat-label text-slate-400">Temperature</div>
              <i class="fa-solid fa-thermometer-half text-slate-400"></i>
            </div>
            <div class="stat-val text-slate-800 dark:text-white">
              <span id="d-temp">0</span><span class="stat-unit text-slate-500">°C</span>
            </div>
          </div>
          
          <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 backdrop-blur-sm">
            <div class="flex items-center justify-between mb-2">
              <div class="stat-label text-slate-400">Avg Daily Usage</div>
              <i class="fa-solid fa-bolt text-slate-400"></i>
            </div>
            <div class="stat-val text-slate-800 dark:text-white">
              <span id="d-avg-daily">0</span><span class="stat-unit text-slate-500">kWh</span>
            </div>
          </div>
        
        </div>
      </div>

      <!-- 2. ANALYSIS PAGE -->
      <div id="page-analysis" class="hidden space-y-4 md:space-y-6">
        <div class="flex justify-between items-center flex-col md:flex-row gap-2 mb-4">
          <h2 class="text-xl font-bold text-slate-800 dark:text-white">Smart Analysis</h2>
          <div class="flex items-center gap-2">
            <!-- <select id="sheetSelector" onchange="fetchMonthData()" class="bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-white text-sm rounded-lg p-2 outline-none focus:ring-2 focus:ring-blue-500">
            </select> -->
            <!-- <div class="flex gap-1">
              <button onclick="setZoom(24, event)" class="zoom-btn active">24h</button>
              <button onclick="setZoom(168, event)" class="zoom-btn">7d</button>
              <button onclick="setZoom(720, event)" class="zoom-btn">30d</button>
              <button onclick="setZoom(8760, event)" class="zoom-btn">All</button>
            </div> -->
          </div>
        </div>
        
        <!-- <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
          <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 backdrop-blur-sm">
            <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4">Voltage Trend</h3>
            <div id="chart-vol" class="chart-container h-64"></div>
          </div>
          <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 backdrop-blur-sm">
            <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4">Power Consumption</h3>
            <div id="chart-pow" class="chart-container h-64"></div>
          </div>
        </div> -->
        
        <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 backdrop-blur-sm">
          <div class="flex items-center gap-2 mb-4">
            <h3 class="font-bold text-slate-700 dark:text-slate-200">Power Usage Intensity (Heatmap)</h3>
            <i class="fa-solid fa-circle-info info-icon" onclick="showInfo('heatmap')"></i>
          </div>
          <div id="chart-heatmap" class="chart-container h-64 md:h-80"></div>
        </div>

        <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 backdrop-blur-sm">
          <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4">Weekly Breakdown</h3>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
            <div class="lg:col-span-2">
              <div id="chart-weekly-bar" class="chart-container h-56 md:h-64"></div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm data-table text-slate-700 dark:text-slate-300">
                <thead class="bg-slate-100 dark:bg-slate-700">
                  <tr><th>Week</th><th>Cost</th><th>Energy</th></tr>
                </thead>
                <tbody id="table-weekly-rows" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 backdrop-blur-sm">
          <div class="flex items-center gap-2 mb-4 border-b dark:border-slate-700 pb-2">
            <h3 class="font-bold text-slate-700 dark:text-slate-200">Grid Reliability (Month)</h3>
            <i class="fa-solid fa-circle-info info-icon" onclick="showInfo('grid')"></i>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 items-center">
            <div class="col-span-1 flex justify-center">
              <div id="chart-grid-donut" class="chart-container"></div>
            </div>
            <div class="col-span-2 grid grid-cols-2 gap-4">
              <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded border border-green-100 dark:border-green-800">
                <div class="text-xs font-bold text-green-700 dark:text-green-400 uppercase">On-Grid</div>
                <div id="grid-on-txt" class="text-xl font-bold text-green-700 dark:text-green-400">--</div>
              </div>
              <div class="bg-red-50 dark:bg-red-900/30 p-4 rounded border border-red-100 dark:border-red-800">
                <div class="text-xs font-bold text-red-700 dark:text-red-400 uppercase">Off-Grid</div>
                <div id="grid-off-txt" class="text-xl font-bold text-red-700 dark:text-red-400">--</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
          <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 backdrop-blur-sm">
            <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-2">Last 24h Peaks</h3>
            <div class="overflow-x-auto">
              <table class="w-full data-table text-slate-700 dark:text-slate-300">
                <thead class="bg-slate-100 dark:bg-slate-700">
                  <tr><th>Param</th><th>High</th><th>Time</th><th>Low</th><th>Time</th></tr>
                </thead>
                <tbody id="table-24h" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
              </table>
            </div>
          </div>
          <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 backdrop-blur-sm">
            <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-2">Last 48h Peaks</h3>
            <div class="overflow-x-auto">
              <table class="w-full data-table text-slate-700 dark:text-slate-300">
                <thead class="bg-slate-100 dark:bg-slate-700">
                  <tr><th>Param</th><th>High</th><th>Time</th><th>Low</th><th>Time</th></tr>
                </thead>
                <tbody id="table-48h" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 3. YEARLY REPORT -->
      <div id="page-yearly" class="hidden space-y-4 md:space-y-6">
        <div class="flex justify-between items-center flex-col md:flex-row gap-2">
          <h2 class="text-xl font-bold text-slate-800 dark:text-white">Yearly Comparison</h2>
          <button onclick="exportCSV('yearly')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-bold shadow transition-colors">
            <i class="fa-solid fa-file-export mr-1"></i> Export CSV
          </button>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
          <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 backdrop-blur-sm lg:col-span-2">
            <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4">Cost Comparison</h3>
            <div id="chart-yr-cost" class="chart-container h-64 md:h-80"></div>
          </div>
          <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 backdrop-blur-sm lg:col-span-2">
            <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4">Energy Comparison</h3>
            <div id="chart-yr-eng" class="chart-container h-64 md:h-80"></div>
          </div>
        </div>
        
        <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 backdrop-blur-sm">
          <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4">Detailed Breakdown</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left data-table text-slate-700 dark:text-slate-300">
              <thead id="yearly-table-head" class="bg-slate-100 dark:bg-slate-700"></thead>
              <tbody id="yearly-table-body" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 4. SETTINGS & ALERTS -->
      <div id="page-alerts" class="hidden space-y-4 md:space-y-6">
        <h2 class="text-xl font-bold text-slate-800 dark:text-white">Settings & Alerts</h2>
        
        <div class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 border-l-4 border-l-red-500 backdrop-blur-sm">
          <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4">System Thresholds</h3>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3 md:gap-4">
            <div>
              <label class="text-xs font-bold text-slate-500">Max Voltage (V)</label>
              <input id="set-vol" type="number" min="0" max="300" class="w-full border p-2 rounded mt-1 dark:bg-slate-700 dark:border-slate-600 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500">Min Voltage (V)</label>
              <input id="set-low-vol" type="number" min="0" max="300" class="w-full border p-2 rounded mt-1 dark:bg-slate-700 dark:border-slate-600 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500">Max Power (W)</label>
              <input id="set-pow" type="number" min="0" max="10000" class="w-full border p-2 rounded mt-1 dark:bg-slate-700 dark:border-slate-600 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500">Max Temp (°C)</label>
              <input id="set-temp" type="number" min="0" max="100" class="w-full border p-2 rounded mt-1 dark:bg-slate-700 dark:border-slate-600 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <div class="md:col-span-4 border-t pt-4 dark:border-slate-600">
              <label class="text-xs font-bold text-slate-500">Monthly Budget Target (₦)</label>
              <input id="set-budget" type="number" min="0" class="w-full md:w-1/3 border p-2 rounded mt-1 dark:bg-slate-700 dark:border-slate-600 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="50000">
            </div>
          </div>
          <button onclick="saveSettings()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-bold transition-colors w-full md:w-auto">
            Save System Settings
          </button>
        </div>
        
        <!-- ALERT HISTORY CARD WITH FULLSCREEN BUTTON -->
        <div id="alert-card" class="card bg-white/50 dark:bg-slate-800/50 border dark:border-slate-700 backdrop-blur-sm">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-slate-700 dark:text-slate-200">Alert History</h3>
            <div>
              <button onclick="toggleAlertsFullscreen()" class="text-slate-500 hover:text-blue-600 mr-3 transition-colors" title="Toggle Fullscreen">
                <i id="alert-expand-icon" class="fa-solid fa-expand text-lg"></i>
              </button>
              <button onclick="loadAlerts()" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition-colors" title="Refresh">
                <i class="fa-solid fa-rotate"></i>
              </button>
            </div>
          </div>
          <div class="overflow-x-auto h-64 md:h-96">
            <table class="w-full text-sm text-left data-table text-slate-700 dark:text-slate-300">
              <thead class="bg-slate-100 dark:bg-slate-700">
                <tr>
                  <th>Time</th>
                  <th>Type</th>
                  <th>Value</th>
                  <th>Message</th>
                </tr>
              </thead>
              <tbody id="alert-table-body" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // --- INFO MODAL DATA ---
    const infoData = {
        heatmap: {
            title: "How to read the Heatmap",
            icon: "fa-fire",
            content: `
                <p>This chart visualizes your energy habits over the week.</p>
                <ul class="list-disc pl-4 space-y-1 mt-2">
                    <li><strong>Rows:</strong> Days of the week (Sun-Sat).</li>
                    <li><strong>Columns:</strong> Hours of the day (00:00 - 23:00).</li>
                    <li><span class="text-green-500 font-bold">Green:</span> Low usage (e.g., Standby).</li>
                    <li><span class="text-yellow-500 font-bold">Yellow:</span> Medium usage (e.g., TV/Lights).</li>
                    <li><span class="text-red-500 font-bold">Red:</span> High usage (e.g., AC/Heater/Iron).</li>
                </ul>
                <p class="mt-2 text-xs italic">Use this to identify which appliances are running at specific times.</p>
            `
        },
        carbon: {
            title: "Carbon Footprint",
            icon: "fa-leaf",
            content: `
                <p>An estimate of the CO₂ emissions generated by your electricity usage.</p>
                <p class="mt-2"><strong>Formula:</strong> <code>kWh × 0.43 kgCO₂</code></p>
                <p class="mt-2">This factor represents the average grid emission intensity. Offset shows how many trees would be needed to absorb this amount of carbon in a year.</p>
            `
        },
        pf: {
            title: "Power Factor (PF)",
            icon: "fa-bolt",
            content: `
                <p>A measure of how efficiently your appliances convert electricity into useful work.</p>
                <ul class="list-disc pl-4 space-y-1 mt-2">
                    <li><strong>1.00:</strong> Perfect efficiency (Pure resistive load).</li>
                    <li><strong>0.85 - 0.99:</strong> Good efficiency.</li>
                    <li><strong>Below 0.80:</strong> Poor efficiency (Inductive loads like motors/old fans without capacitors).</li>
                </ul>
                <p class="mt-2 text-xs text-red-500">Low PF draws more current for the same power!</p>
            `
        },
        grid: {
            title: "Grid Reliability",
            icon: "fa-tower-cell",
            content: `
                <p>Tracks the availability of power supply for the current month.</p>
                <ul class="list-disc pl-4 space-y-1 mt-2">
                    <li><strong>On-Grid:</strong> Total hours power was available.</li>
                    <li><strong>Off-Grid:</strong> Total hours of blackout/outage.</li>
                </ul>
                <p class="mt-2 text-xs">Calculated by detecting gaps in the data stream > 10 minutes.</p>
            `
        },
        voltage: {
            title: "Voltage Monitoring",
            icon: "fa-bolt",
            content: `
                <p>Standard voltage range for most electrical systems is 220V-240V.</p>
                <ul class="list-disc pl-4 space-y-1 mt-2">
                    <li><strong>Too High (>250V):</strong> Can damage appliances.</li>
                    <li><strong>Too Low (<180V):</strong> Can cause appliances to malfunction.</li>
                    <li><strong>Optimal:</strong> 220V-240V for stable operation.</li>
                </ul>
                <p class="mt-2 text-xs">Set alerts to monitor voltage fluctuations.</p>
            `
        }
    };

    function showInfo(key) {
        const data = infoData[key];
        if(!data) return;
        document.getElementById('info-title').innerText = data.title;
        document.getElementById('info-content').innerHTML = data.content;
        document.getElementById('info-icon-display').className = `fa-solid ${data.icon} text-xl`;
        document.getElementById('info-modal').classList.remove('hidden');
    }

    function closeInfo() {
        document.getElementById('info-modal').classList.add('hidden');
    }

    // --- MAIN LOGIC ---
    let chartInst = {};
    let globalData = [];
    let currentZoomHours = 24;
    let monthlyBudget = 50000;
    let mobileMenuTimeout;
    let touchStartX = 0;
    let touchEndX = 0;
    let autoRefreshInterval;

    window.onload = function() {
      refreshData();
      autoRefreshInterval = setInterval(refreshData, 30000);
      loadSettings();
      setupTouchGestures();
      setupAutoHideMenu();
      
      // Initialize sidebar observer
      const sidebar = document.getElementById('sidebar');
      const toggleBtn = document.getElementById('mobile-menu-toggle');
      
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'class') {
            if (sidebar.classList.contains('mobile-menu-closed')) {
              toggleBtn.classList.remove('hidden');
            } else {
              toggleBtn.classList.add('hidden');
            }
          }
        });
      });
      observer.observe(sidebar, { attributes: true });

      // Check for PWA installation
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
          .then(() => console.log('Service Worker registered'))
          .catch(err => console.log('Service Worker registration failed:', err));
      }
    };

    function setupTouchGestures() {
      const mainContent = document.getElementById('main-content');
      mainContent.addEventListener('touchstart', function(e) { 
        touchStartX = e.changedTouches[0].screenX; 
      }, false);
      mainContent.addEventListener('touchend', function(e) { 
        touchEndX = e.changedTouches[0].screenX; 
        handleSwipe(); 
      }, false);
    }

    function handleSwipe() {
      const swipeThreshold = 50;
      const diff = touchStartX - touchEndX;
      if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
          if (window.innerWidth < 768 && !document.getElementById('sidebar').classList.contains('mobile-menu-closed')) { 
            toggleMobileMenu(); 
          }
        } else {
          if (window.innerWidth < 768 && document.getElementById('sidebar').classList.contains('mobile-menu-closed')) { 
            toggleMobileMenu(); 
          }
        }
      }
    }

    function setupAutoHideMenu() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('main-content');
      if (window.innerWidth < 768) {
        mainContent.addEventListener('click', function() {
          if (!sidebar.classList.contains('mobile-menu-closed')) {
            clearTimeout(mobileMenuTimeout);
            mobileMenuTimeout = setTimeout(() => { 
              if (!sidebar.classList.contains('mobile-menu-closed')) { 
                toggleMobileMenu(); 
              } 
            }, 5000);
          }
        });
        sidebar.addEventListener('mouseenter', function() { clearTimeout(mobileMenuTimeout); });
        sidebar.addEventListener('mouseleave', function() { 
          if (!sidebar.classList.contains('mobile-menu-closed')) { 
            mobileMenuTimeout = setTimeout(() => { 
              if (!sidebar.classList.contains('mobile-menu-closed')) { 
                toggleMobileMenu(); 
              } 
            }, 3000); 
          } 
        });
      }
    }

    function toggleTheme() {
      const html = document.documentElement;
      if(html.classList.contains('dark')) { 
        html.classList.remove('dark'); 
        localStorage.setItem('theme', 'light'); 
        showToast('Switched to Light Mode', 'info');
      } else { 
        html.classList.add('dark'); 
        localStorage.setItem('theme', 'dark'); 
        showToast('Switched to Dark Mode', 'info');
      }
      if(globalData.length > 0) renderMonth({success:true, data:globalData});
      fetchDetailedYearly();
    }

    function toggleLoader(show) { 
      document.getElementById('main-loader').classList.toggle('hidden', !show); 
    }
    
    function toggleMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobile-overlay');
      sidebar.classList.toggle('mobile-menu-closed');
      sidebar.classList.toggle('mobile-menu-open');
      overlay.classList.toggle('hidden');
      if (!sidebar.classList.contains('mobile-menu-closed')) {
        clearTimeout(mobileMenuTimeout);
        mobileMenuTimeout = setTimeout(() => { 
          if (!sidebar.classList.contains('mobile-menu-closed')) { 
            toggleMobileMenu(); 
          } 
        }, 5000);
      }
    }

    function toggleAlertsFullscreen() {
      const card = document.getElementById('alert-card');
      const icon = document.getElementById('alert-expand-icon');
      const body = document.body;

      card.classList.toggle('fullscreen-card');

      if (card.classList.contains('fullscreen-card')) {
        icon.classList.remove('fa-expand');
        icon.classList.add('fa-compress');
        body.style.overflow = 'hidden';
        showToast('Entered fullscreen mode', 'info');
      } else {
        icon.classList.remove('fa-compress');
        icon.classList.add('fa-expand');
        body.style.overflow = 'auto';
      }
    }

    function refreshData() { 
      google.script.run.withSuccessHandler(updateState).getDashboardState(); 
    }

    function updateState(res) {
      if(!res.success) {
        showToast('Failed to fetch data', 'error');
        return;
      }
      
      const isOnline = res.status === "ON-GRID";
      const statusBadge = document.getElementById('top-status-badge');
      statusBadge.className = isOnline ? "status-badge status-on" : "status-badge status-off";
      statusBadge.innerHTML = isOnline ? 
        '<i class="fa-solid fa-circle text-[6px] mr-2 blink"></i> ON-GRID' : 
        '<i class="fa-solid fa-circle text-[6px] mr-2"></i> OFFLINE';
      
      document.getElementById('side-status-text').innerText = isOnline ? "Online" : "Offline";

      if(res.budget) { 
        monthlyBudget = parseFloat(res.budget); 
      }

      // Update sheet selector
      const sheetSel = document.getElementById('sheetSelector');
      if(sheetSel && (sheetSel.options.length <= 1 || sheetSel.options[0].text === 'Loading...')) {
        sheetSel.innerHTML = "";
        if(res.sheets && res.sheets.length > 0) {
          res.sheets.forEach(s => { 
            let o = document.createElement('option'); 
            o.value = s; 
            o.text = s; 
            sheetSel.appendChild(o); 
          });
        }
      }

      if(res.latest) {
        const l = res.latest;
        document.getElementById('last-updated-main').innerText = l.ts || '--';
        document.getElementById('side-last-update').innerText = `Last update: ${l.ts || '--'}`;
        
        // Update all dashboard values
        setTxt('d-vol', l.vol.toFixed(1));
        setTxt('d-cur', l.cur.toFixed(2));
        setTxt('d-pow', Math.round(l.pow));
        setTxt('d-m-eng', l.monthEng.toFixed(2));
        setTxt('d-y-eng', l.yearEng.toFixed(2));
        setTxt('d-freq', l.freq.toFixed(1));
        setTxt('d-pf', l.pf.toFixed(2));
        setTxt('d-temp', l.temp.toFixed(1));
        
        // Calculate and display additional metrics
        const now = new Date();
        const dayOfMonth = now.getDate();
        if (dayOfMonth > 0 && l.monthEng > 0) {
          const avgDaily = l.monthEng / dayOfMonth;
          setTxt('d-avg-daily', avgDaily.toFixed(2));
        }
        
        // Currency formatting
        let fmt = new Intl.NumberFormat('en-NG', {style:'currency', currency:'NGN'});
        document.getElementById('d-m-cost').innerText = fmt.format(l.monthCost);
        document.getElementById('d-y-cost').innerText = fmt.format(l.yearCost);

        // Projected bill calculation
        if(dayOfMonth > 0) {
          const totalDays = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
          const dailyAvg = l.monthCost / dayOfMonth;
          const pred = dailyAvg * totalDays;
          document.getElementById('d-pred-cost').innerText = fmt.format(pred);
          document.getElementById('d-pred-desc').innerText = `~${fmt.format(dailyAvg)} / day`;
        }

        // Budget bar updates
        if(document.getElementById('budget-bar')) {
          let spend = l.monthCost;
          let percent = (spend / monthlyBudget) * 100;
          if(percent > 100) percent = 100;
          document.getElementById('budget-bar').style.width = percent + "%";
          document.getElementById('budget-text').innerText = percent.toFixed(1) + "% Used";
          document.getElementById('budget-target-display').innerText = monthlyBudget.toLocaleString();
          document.getElementById('curr-spend').innerText = fmt.format(spend);
          
          // Update bar color based on percentage
          let bar = document.getElementById('budget-bar');
          bar.className = "h-4 rounded-full transition-all duration-500";
          if(percent < 50) bar.classList.add("bg-green-500");
          else if(percent < 85) bar.classList.add("bg-yellow-500");
          else bar.classList.add("bg-red-500");
        }

        // Carbon footprint calculation
        if(document.getElementById('co2-val')) {
          let kwh = l.monthEng;
          let co2 = kwh * 0.43;
          let trees = co2 / 1.75;
          document.getElementById('co2-val').innerText = co2.toFixed(1);
          document.getElementById('tree-val').innerText = trees.toFixed(1);
        }
      }
    }

    function setTxt(id, val) { 
      const el = document.getElementById(id);
      if(el) el.innerText = val; 
    }

    function toggleChartsMenu() {
      const menu = document.getElementById('charts-submenu');
      const arrow = document.getElementById('charts-arrow');
      if (menu.classList.contains('hidden')) {
        menu.classList.remove('hidden');
        menu.classList.add('flex');
        arrow.style.transform = "rotate(180deg)";
      } else {
        menu.classList.add('hidden');
        menu.classList.remove('flex');
        arrow.style.transform = "rotate(0deg)";
      }
    }

    function showPage(p) {
      if (window.innerWidth < 768) {
        const sidebar = document.getElementById('sidebar');
        if (!sidebar.classList.contains('mobile-menu-closed')) { 
          toggleMobileMenu(); 
        }
      }
      
      // Hide all pages and remove active classes
      ['dashboard', 'analysis', 'yearly', 'alerts'].forEach(x => {
        const pageEl = document.getElementById('page-'+x);
        const navEl = document.getElementById('nav-'+x);
        if(pageEl) pageEl.classList.add('hidden');
        if(navEl) navEl.classList.remove('active');
      });
      
      // Show selected page and set active
      const pageEl = document.getElementById('page-'+p);
      const navEl = document.getElementById('nav-'+p);
      if(pageEl) pageEl.classList.remove('hidden');
      if(navEl) navEl.classList.add('active');
      
      // Update page title
      const titles = {
        'dashboard': 'Dashboard',
        'analysis': 'Smart Analysis',
        'yearly': 'Yearly Report',
        'alerts': 'Settings & Alerts'
      };
      document.getElementById('page-title').innerText = titles[p] || p.charAt(0).toUpperCase() + p.slice(1);
      
      // Page-specific actions
      document.getElementById('selector-container').classList.add('hidden');

      if(p === 'analysis') {
        document.getElementById('selector-container').classList.remove('hidden');
        fetchMonthData();
      } else if (p === 'yearly') {
        fetchDetailedYearly();
      } else if (p === 'alerts') {
        loadAlerts();
        loadSettings();
      }
    }

    function fetchMonthData() {
      const s = document.getElementById('sheetSelector').value;
      if(s && s !== "Loading...") { 
        toggleLoader(true); 
        google.script.run.withSuccessHandler(r => { 
          renderMonth(r); 
          toggleLoader(false); 
        }).getMonthData(s); 
      }
    }

    function setZoom(hours, evt) {
      currentZoomHours = hours;
      document.querySelectorAll('.zoom-btn').forEach(b => b.classList.remove('active'));
      evt.target.classList.add('active');
      if(globalData.length > 0) {
        renderMonth({success:true, data: globalData});
      }
    }

    function renderMonth(res) {
      if(!res.success) {
        showToast('Failed to load month data', 'error');
        return;
      }
      
      globalData = res.data;
      const d = res.data;
      if(d.length === 0) {
        showToast('No data available for selected period', 'warning');
        return;
      }
      
      const latestTs = d[d.length-1].ts;
      const cutoff = latestTs - (currentZoomHours * 3600 * 1000);
      const filtered = d.filter(x => x.ts > cutoff);
      const rate = Math.ceil(filtered.length/400);
      const cd = filtered.filter((_, i) => i % rate === 0);
      
      const isDark = document.documentElement.classList.contains('dark');
      const textColor = isDark ? '#cbd5e1' : '#374151';
      const gridColor = isDark ? '#475569' : '#e2e8f0';

      // Render charts
      renderApex('chart-vol', 'Voltage', '#3b82f6', cd, 'vol', textColor, gridColor);
      renderApex('chart-pow', 'Power', '#f97316', cd, 'pow', textColor, gridColor);
      
      // Only render energy chart if we have energy data
      if(cd.some(x => x.eng !== null)) {
        renderApex('chart-eng', 'Energy', '#eab308', cd, 'eng', textColor, gridColor);
      }

      // Calculate peaks for last 24h and 48h
      const d24 = d.filter(x => (latestTs - x.ts) <= 86400000);
      const d48 = d.filter(x => (latestTs - x.ts) <= 172800000);
      populateTable('table-24h', d24);
      populateTable('table-48h', d48);
      
      // Render analysis charts
      renderGridAnalysis(d, 'chart-grid-donut', 'grid-on-txt', 'grid-off-txt');
      renderHeatmap(d, textColor, gridColor);
      calculateWeekly(d, textColor, gridColor);
    }

    function calculateWeekly(data, textColor, gridColor) {
      let weeks = {1:{}, 2:{}, 3:{}, 4:{}, 5:{}};
      for(let i=1;i<=5;i++) weeks[i] = { costS: 999999, costE: 0, engS: 999999, engE: 0, hasData: false };
      
      data.forEach(d => {
        let date = new Date(d.ts);
        let w = Math.ceil(date.getDate()/7);
        if(w>5) w=5;
        weeks[w].hasData = true;
        if(d.cost < weeks[w].costS) weeks[w].costS = d.cost;
        if(d.cost > weeks[w].costE) weeks[w].costE = d.cost;
        if(d.eng < weeks[w].engS) weeks[w].engS = d.eng;
        if(d.eng > weeks[w].engE) weeks[w].engE = d.eng;
      });
      
      let cats = [], series = [], html = "";
      for(let w=1; w<=5; w++) {
        let c = 0, e = 0;
        if(weeks[w].hasData) { 
          c = weeks[w].costE - weeks[w].costS; 
          e = weeks[w].engE - weeks[w].engS; 
          if(c<0) c=weeks[w].costE; 
        }
        cats.push("W"+w); 
        series.push(c);
        let fmt = new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN' });
        if(weeks[w].hasData) {
          html += `<tr><td>Week ${w}</td><td class="font-bold text-green-600 dark:text-green-400">${fmt.format(c)}</td><td class="text-slate-500 dark:text-slate-400">${e.toFixed(2)} kWh</td></tr>`;
        }
      }
      document.getElementById('table-weekly-rows').innerHTML = html || "<tr><td colspan='3'>No Data</td></tr>";
      renderBar('chart-weekly-bar', cats, series, '#22c55e', textColor, gridColor);
    }

    function renderHeatmap(data, textColor, gridColor) {
      let grid = Array(7).fill().map(() => Array(24).fill(0));
      let counts = Array(7).fill().map(() => Array(24).fill(0));
      
      data.forEach(d => {
        let date = new Date(d.ts);
        let day = date.getDay();
        let h = date.getHours();
        grid[day][h] += d.pow;
        counts[day][h]++;
      });
      
      for(let d=0; d<7; d++) { 
        for(let h=0; h<24; h++) { 
          if(counts[d][h]>0) grid[d][h] = Math.round(grid[d][h] / counts[d][h]); 
        } 
      }
      
      const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
      let series = days.map((day, i) => ({ 
        name: day, 
        data: grid[i].map((v, h) => ({
          x: h.toString().padStart(2,'0')+":00", 
          y: v
        }))
      })).reverse();
      
      if(chartInst['heatmap']) chartInst['heatmap'].destroy();
      
      chartInst['heatmap'] = new ApexCharts(document.querySelector("#chart-heatmap"), {
        series: series, 
        chart: { 
          type: 'heatmap', 
          height: 300, 
          toolbar: {show:false}, 
          foreColor: textColor 
        }, 
        dataLabels: { enabled: false },
        plotOptions: { 
          heatmap: { 
            shadeIntensity: 0.5, 
            colorScale: { 
              ranges: [
                {from:0, to:100, color:'#10b981', name:'Low'},
                {from:101, to:400, color:'#facc15', name:'Med'},
                {from:401, to:10000, color:'#ef4444', name:'High'}
              ] 
            } 
          } 
        },
        grid: { borderColor: gridColor }
      });
      chartInst['heatmap'].render();
    }

    function populateTable(id, dataset) {
      let html = "";
      const params = [
        {k:'vol', n:'Volt', u:'V'},
        {k:'pow', n:'Power', u:'W'}, 
        {k:'temp', n:'Temp', u:'C'},
        {k:'cur', n:'Current', u:'A'},
        {k:'freq', n:'Freq', u:'Hz'}
      ];
      
      params.forEach(p => {
        let max = -999, min = 999, maxT = "", minT = "";
        dataset.forEach(d => { 
          if(d[p.k] > max) { max = d[p.k]; maxT = d.tsStr.split(' ')[1]; } 
          if(d[p.k] < min && d[p.k] > 0) { min = d[p.k]; minT = d.tsStr.split(' ')[1]; } 
        });
        
        if(max === -999) max = 0;
        if(min === 999) min = 0;
        
        html += `<tr>
          <td>${p.n}</td>
          <td class="text-red-600 dark:text-red-400 font-bold">${max.toFixed(1)}${p.u}</td>
          <td class="text-xs text-slate-500">${maxT || '--'}</td>
          <td class="text-blue-600 dark:text-blue-400 font-bold">${min.toFixed(1)}${p.u}</td>
          <td class="text-xs text-slate-500">${minT || '--'}</td>
        </tr>`;
      });
      
      document.getElementById(id).innerHTML = html || "<tr><td colspan='5'>No data</td></tr>";
    }

    function renderGridAnalysis(data, chartId, onId, offId) {
      if(data.length < 2) {
        document.getElementById(onId).innerText = '0h';
        document.getElementById(offId).innerText = '0h';
        return;
      }
      
      let offTime = 0;
      for(let i=1; i<data.length; i++) {
        let diff = (data[i].ts - data[i-1].ts) / 1000 / 60;
        if(diff > 11) offTime += diff;
      }
      
      let totalSpan = (data[data.length-1].ts - data[0].ts) / 1000 / 60;
      let onTime = Math.max(0, totalSpan - offTime);
      let onHrs = (onTime/60).toFixed(1);
      let offHrs = (offTime/60).toFixed(1);
      
      document.getElementById(onId).innerText = `${onHrs}h`;
      document.getElementById(offId).innerText = `${offHrs}h`;
      
      const isDark = document.documentElement.classList.contains('dark');
      if(chartInst[chartId]) chartInst[chartId].destroy();
      
      chartInst[chartId] = new ApexCharts(document.querySelector("#"+chartId), {
        series: [parseFloat(onHrs), parseFloat(offHrs)],
        chart: {
          type: 'donut',
          height: 250,
          foreColor: isDark ? '#cbd5e1' : '#374151'
        },
        labels: ['On-Grid', 'Off-Grid'],
        colors: ['#16a34a', '#dc2626'],
        legend: {position: 'bottom'},
        stroke: { show: false },
        plotOptions: {
          pie: {
            donut: {
              size: '70%'
            }
          }
        }
      });
      chartInst[chartId].render();
    }

    function fetchDetailedYearly() {
      toggleLoader(true);
      google.script.run.withSuccessHandler(res => {
        if(res.success) {
          renderYearly(res.data);
        } else {
          showToast('Failed to load yearly data', 'error');
        }
        toggleLoader(false);
      }).getDetailedYearlyReport();
    }

    function renderYearly(data) {
      if(!data || data.length === 0) {
        showToast('No yearly data available', 'warning');
        return;
      }
      
      globalData = data;
      let years = [...new Set(data.map(d => d.year))].sort();
      let months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      let pivotC = {}, pivotE = {}, totals = {};
      
      const palette = [
        '#2563eb', '#dc2626', '#16a34a', '#d97706', '#7c3aed', '#db2777',
        '#0891b2', '#4d7c0f', '#4f46e5', '#ea580c', '#0d9488', '#c026d3'
      ];
      
      years.forEach(y => { 
        pivotC[y] = new Array(12).fill(0); 
        pivotE[y] = new Array(12).fill(0); 
        totals[y] = { cost: 0, eng: 0 }; 
      });
      
      data.forEach(d => { 
        if(d.monthIdx >= 0 && d.monthIdx < 12) {
          pivotC[d.year][d.monthIdx] = d.cost || 0; 
          pivotE[d.year][d.monthIdx] = d.energy || 0; 
          totals[d.year].cost += d.cost || 0; 
          totals[d.year].eng += d.energy || 0; 
        }
      });
      
      const isDark = document.documentElement.classList.contains('dark');
      const textColor = isDark ? '#cbd5e1' : '#374151';
      const gridColor = isDark ? '#475569' : '#e2e8f0';
      
      let seriesCost = years.map(y => ({ name: y.toString(), data: pivotC[y] }));
      let seriesEng = years.map(y => ({ name: y.toString(), data: pivotE[y] }));
      let activeColors = years.map((_, i) => palette[i % palette.length]);
      
      renderBarGroup('chart-yr-cost', seriesCost, months, false, textColor, gridColor, activeColors);
      renderBarGroup('chart-yr-eng', seriesEng, months, true, textColor, gridColor, activeColors);
      
      // Build table
      let thead = `<tr>
        <th class="px-6 py-3 text-left tracking-wider">Month</th>`;
      
      years.forEach((y, i) => { 
        let color = activeColors[i]; 
        thead += `
          <th class="px-6 py-3 text-right tracking-wider" style="color:${color};">${y} Cost</th>
          <th class="px-6 py-3 text-right tracking-wider" style="color:${color};">${y} kWh</th>
        `; 
      });
      thead += `</tr>`;
      document.getElementById('yearly-table-head').innerHTML = thead;
      
      let tbody = "";
      months.forEach((m, i) => {
        let row = `<tr class="border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800">
          <td class="px-6 py-3 font-medium text-slate-700 dark:text-slate-200">${m}</td>`;
        
        years.forEach(y => { 
          let c = pivotC[y][i] || 0; 
          let e = pivotE[y][i] || 0;
          let cStr = c > 0 ? '₦' + c.toLocaleString('en-NG', {minimumFractionDigits: 2}) : '-';
          let eStr = e > 0 ? e.toFixed(1) : '-';
          
          row += `
            <td class="px-6 py-3 text-right font-bold ${c > 0 ? 'text-slate-700 dark:text-slate-300' : 'text-slate-300 dark:text-slate-600'}">${cStr}</td>
            <td class="px-6 py-3 text-right font-bold ${e > 0 ? 'text-slate-700 dark:text-slate-300' : 'text-slate-300 dark:text-slate-600'}">${eStr}</td>
          `; 
        });
        row += `</tr>`;
        tbody += row;
      });
      
      // Add totals row
      let totalRow = `<tr class="bg-slate-100 dark:bg-slate-800 font-bold">
        <td class="px-6 py-4">TOTAL</td>`;
      years.forEach(y => { 
        totalRow += `
          <td class="px-6 py-4 text-right">₦${totals[y].cost.toLocaleString('en-NG', {minimumFractionDigits: 2})}</td>
          <td class="px-6 py-4 text-right">${totals[y].eng.toFixed(1)} kWh</td>
        `; 
      });
      totalRow += `</tr>`;
      tbody += totalRow;
      
      document.getElementById('yearly-table-body').innerHTML = tbody;
    }

    function loadSettings() { 
      google.script.run.withSuccessHandler(s => { 
        if(s) {
          document.getElementById('set-vol').value = s.highVol || 250;
          document.getElementById('set-low-vol').value = s.lowVol || 180;
          document.getElementById('set-pow').value = s.highPow || 5000;
          document.getElementById('set-temp').value = s.highTemp || 60;
          document.getElementById('set-budget').value = s.budget || 50000;
        }
      }).getAlertSettings(); 
    }
    
    function saveSettings() { 
      let s = { 
        highVol: parseFloat(document.getElementById('set-vol').value) || 250,
        lowVol: parseFloat(document.getElementById('set-low-vol').value) || 180,
        highPow: parseFloat(document.getElementById('set-pow').value) || 5000,
        highTemp: parseFloat(document.getElementById('set-temp').value) || 60,
        budget: parseFloat(document.getElementById('set-budget').value) || 50000
      }; 
      
      google.script.run.withSuccessHandler(res => {
        if(res.success) {
          showToast('Settings saved successfully', 'success');
          refreshData(); // Refresh to update budget
        } else {
          showToast('Failed to save settings', 'error');
        }
      }).saveAlertSettings(s); 
    }
    
    function loadAlerts() { 
      google.script.run.withSuccessHandler(res => { 
        let html = ""; 
        if(res.success && res.logs && res.logs.length > 0) {
          res.logs.forEach(l => { 
            let c = l.type.includes("Voltage") ? "text-blue-600 dark:text-blue-400" : 
                    l.type.includes("Power") ? "text-orange-600 dark:text-orange-400" : 
                    l.type.includes("Temp") ? "text-red-600 dark:text-red-400" : "text-slate-600 dark:text-slate-400";
            html += `<tr>
              <td class="text-xs text-slate-500">${l.time || '--'}</td>
              <td class="font-bold ${c}">${l.type || '--'}</td>
              <td>${l.val || '--'}</td>
              <td class="text-xs text-slate-500">${l.msg || '--'}</td>
            </tr>`; 
          });
        } else {
          html = `<tr><td colspan="4" class="text-center py-4 text-slate-500">No alerts recorded</td></tr>`;
        }
        document.getElementById('alert-table-body').innerHTML = html;
      }).getAlertLogs(); 
    }

    function exportCSV(type) {
      if(!globalData || globalData.length === 0) {
        showToast('No data to export', 'warning');
        return;
      }
      
      let csv = "data:text/csv;charset=utf-8,";
      if(type === 'yearly') {
        csv += "Year,Month,Energy (kWh),Cost (₦)\n";
        globalData.forEach(r => {
          const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
          csv += `${r.year},${monthNames[r.monthIdx]},${r.energy || 0},${r.cost || 0}\n`;
        });
      } else {
        csv += "Time,Voltage (V),Current (A),Power (W),Frequency (Hz),Power Factor,Energy (kWh),Cost (₦)\n";
        globalData.forEach(r => {
          csv += `${r.tsStr},${r.vol || 0},${r.cur || 0},${r.pow || 0},${r.freq || 0},${r.pf || 0},${r.eng || 0},${r.cost || 0}\n`;
        });
      }
      
      const link = document.createElement("a");
      link.href = encodeURI(csv);
      link.download = `waliTech_${type}_export_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('Export completed', 'success');
    }

    function renderApex(id, name, color, data, key, textColor, gridColor) {
      if(chartInst[id]) chartInst[id].destroy();
      
      chartInst[id] = new ApexCharts(document.querySelector("#"+id), {
        series: [{ name: name, data: data.map(d => [d.ts, d[key] || 0]) }],
        chart: { 
          type: 'area', 
          height: 250, 
          toolbar: {show:false}, 
          animations: {enabled:true},
          foreColor: textColor,
          background: 'transparent'
        },
        stroke: { curve: 'smooth', width: 2 },
        fill: { type: 'gradient', gradient: { opacityFrom: 0.5, opacityTo: 0.1 } },
        colors: [color],
        grid: { borderColor: gridColor },
        xaxis: { type: 'datetime' },
        yaxis: { labels: { formatter: (val) => val.toFixed(1) } },
        tooltip: { 
          theme: document.documentElement.classList.contains('dark') ? 'dark' : 'light',
          x: { format: 'dd MMM yyyy HH:mm' }
        }
      });
      chartInst[id].render();
    }
    
    function renderBar(id, cats, data, color, textColor, gridColor) {
      if(chartInst[id]) chartInst[id].destroy();
      
      chartInst[id] = new ApexCharts(document.querySelector("#"+id), {
        series: [{name:'Value', data:data}],
        chart: {
          type:'bar',
          height:250,
          toolbar:{show:false},
          foreColor: textColor,
          background: 'transparent'
        },
        colors: [color],
        grid: { borderColor: gridColor },
        xaxis: {categories:cats},
        plotOptions: {bar: {borderRadius:4}},
        tooltip: { 
          theme: document.documentElement.classList.contains('dark') ? 'dark' : 'light'
        }
      });
      chartInst[id].render();
    }

    function renderBarGroup(id, series, cats, isEnergy, textColor, gridColor, colors) {
      if(chartInst[id]) chartInst[id].destroy();
      
      chartInst[id] = new ApexCharts(document.querySelector("#"+id), {
        series: series,
        chart: {
          type:'bar',
          height:300,
          toolbar:{show:false},
          foreColor: textColor,
          background: 'transparent'
        },
        grid: { borderColor: gridColor },
        xaxis: {categories:cats},
        colors: colors,
        plotOptions: {
          bar: {
            borderRadius:4,
            columnWidth: '60%'
          }
        },
        dataLabels: {enabled:false},
        yaxis: {
          labels: {
            formatter: (val) => isEnergy ? 
              val.toFixed(2) + ' kWh' : 
              '₦' + val.toLocaleString('en-NG', {minimumFractionDigits: 2})
          }
        },
        tooltip: {
          theme: document.documentElement.classList.contains('dark') ? 'dark' : 'light',
          y: {
            formatter: (val) => isEnergy ? 
              val.toFixed(2) + ' kWh' : 
              '₦' + val.toLocaleString('en-NG', {minimumFractionDigits: 2})
          }
        }
      });
      chartInst[id].render();
    }
  </script>
</body>
</html>
